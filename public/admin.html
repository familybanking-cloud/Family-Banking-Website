<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Family Banking</title>
<style>
body { background:#d21616; color:#fff; font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif; margin:0; padding:0; line-height:1.6; }
header { background:#000; color:#f9f100; padding:10px; text-align:center; }
section { width:90%; margin:20px auto; }
h2 { color:#fff; }
table { width:100%; border-collapse:collapse; margin-bottom:10px; }
th,td { border:1px solid #f90606; padding:8px; text-align:center; }
th { background:#f7ff08; color:#f7060e; }
input, select { width:100%; box-sizing:border-box; }
button { padding:5px 10px; margin-top:5px; background:#070707; color:#fff; border:none; cursor:pointer; }
button:hover { background:#fd0808; }
footer { background:#060606; color:#f2fa00; text-align:center; padding:15px; margin-top:40px; }
#bank-total-box {
  background: #fff700;
  color: #000;
  padding: 20px 20px;
  border-radius: 15px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  text-align: center;
  font-family: Arial, sans-serif;
  max-width: 200px;
  margin: 30px auto; /* centers the box */
}

#bank-total-box h2 {
  font-size: 2rem;
  margin-bottom: 10px;
}

#bank-total-box p {
  font-size: 2.2rem;
  font-weight: bold;
}

@keyframes flashDeposit {
  0% { transform: scale(1); background-color: #b6ffb6; }
  50% { transform: scale(1.2); background-color: #90ee90; }
  100% { transform: scale(1); background-color: #b6ffb6; }
}

@keyframes flashWithdrawal {
  0% { transform: scale(1); background-color: #ffb6b6; }
  50% { transform: scale(1.2); background-color: #ff7f7f; }
  100% { transform: scale(1); background-color: #ffb6b6; }
}

.flash-deposit {
  animation: flashDeposit 0.8s ease-in-out;
}

.flash-withdrawal {
  animation: flashWithdrawal 0.8s ease-in-out;
}

#bank-total-box {
  width: 250px;
  margin: 20px auto;
  padding: 20px;
  border-radius: 15px;
  background-color: #ffff00;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  font-size: 1.5rem;
  font-weight: bold;
  text-align: center;
}

</style>
</head>
<body>

<header>
  <h1>Admin Dashboard</h1>
  <p>Welcome, <span id="adminName"></span></p>
  <button onclick="logout()">Logout</button>
</header>

<div id="bank-total-box">
  <h2>Bank TotalðŸ’°</h2>
  <p id="bankTotalAmount">$0.00</p>
</div>

<!-- Members -->
<section>
  <h2>Members</h2>
  <table id="membersTable">
    <thead>
      <tr><th>Start Date</th><th>Name</th><th>Status</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addMemberRow()">Add Member</button>
</section>

<!-- Weekly Contributions -->
<section>
  <h2>Weekly Contributions</h2>
  <table id="weeklyTable">
    <thead>
      <tr><th>Member Name</th><th>Date</th><th>Amount</th><th>Balance</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addWeeklyRow()">Add Contribution</button>
</section>

<!-- Withdrawals -->
<section>
  <h2>Withdrawals</h2>
  <table id="withdrawalTable">
    <thead>
      <tr><th>Member Name</th><th>Date</th><th>Amount Withdrawn</th><th>Balance</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addWithdrawalRow()">Add Withdrawal</button>
</section>

<!-- Loans -->
<section>
  <h2>Loans</h2>
  <table id="loanTable">
    <thead>
      <tr><th>Member Name</th><th>Date Taken</th><th>Amount Borrowed</th><th>Repayment</th><th>Loan Left</th><th>Late Fee</th><th>Status</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addLoanRow()">Add Loan</button>
</section>

<h3>Add Winner</h3>
<input id="winnerName" placeholder="Winner Name">
<input id="winnerImage" placeholder="Image URL">
<select id="winnerType">
  <option value="weekly">Weekly</option>
  <option value="monthly">Monthly</option>
</select>
<button onclick="addWinner()">Add Winner</button>

<script>
let data = { members: [], weekly: [], withdrawals: [], loans: [] };

// ---------- Load Data ----------
async function loadData() {
  try {
    const res = await fetch("/api/admin-data");
    data = await res.json();
    renderAll();
  } catch (err) { console.error(err); alert("Failed to load data"); }
}

// ---------- Balances ----------
function getMemberBalances() {
  const balances = {};
  data.members.forEach(m => balances[m.username] = 0);
  data.weekly.forEach(w => balances[w.member] = (balances[w.member] || 0) + parseFloat(w.amount||0));
  data.withdrawals.forEach(w => balances[w.member] = (balances[w.member] || 0) - parseFloat(w.withdrawn||0));
  data.loans.forEach(l => balances[l.member] = (balances[l.member] || 0) - parseFloat(l.borrowed||0) + parseFloat(l.repayment||0));
  return balances;
}

// ---------- Render Functions ----------
function renderMembers() {
  const tbody = document.querySelector("#membersTable tbody");
  tbody.innerHTML = "";
  data.members.forEach((m) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="date" value="${m.startDate||''}" onchange="updateMember('${m.username}', 'startDate', this.value)"></td>
      <td><input type="text" value="${m.name||''}" onchange="updateMember('${m.username}', 'name', this.value)"></td>
      <td>
        <select onchange="updateMember('${m.username}', 'status', this.value)">
          <option value="active" ${m.status==='active'?'selected':''}>Active</option>
          <option value="inactive" ${m.status==='inactive'?'selected':''}>Inactive</option>
        </select>
      </td>
      <td><button onclick="deleteMember('${m.username}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderWeekly() {
  const tbody = document.querySelector("#weeklyTable tbody");
  tbody.innerHTML = "";
  const balances = getMemberBalances();
  data.weekly.forEach(w => {
    const current = balances[w.member] || 0;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" value="${w.member||''}" onchange="updateWeekly('${w._id}', 'member', this.value)"></td>
      <td><input type="date" value="${w.date||''}" onchange="updateWeekly('${w._id}', 'date', this.value)"></td>
      <td><input type="number" value="${w.amount||0}" onchange="updateWeekly('${w._id}', 'amount', this.value)"></td>
      <td>${current.toFixed(2)}</td>
      <td><button onclick="deleteWeekly('${w._id}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderWithdrawals() {
  const tbody = document.querySelector("#withdrawalTable tbody");
  tbody.innerHTML = "";
  const balances = getMemberBalances();
  data.withdrawals.forEach(w => {
    const after = (balances[w.member] || 0) - parseFloat(w.withdrawn||0);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" value="${w.member||''}" onchange="updateWithdrawal('${w._id}', 'member', this.value)"></td>
      <td><input type="date" value="${w.date||''}" onchange="updateWithdrawal('${w._id}', 'date', this.value)"></td>
      <td><input type="number" value="${w.withdrawn||0}" onchange="updateWithdrawal('${w._id}', 'withdrawn', this.value)"></td>
      <td>${after.toFixed(2)}</td>
      <td><button onclick="deleteWithdrawal('${w._id}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderLoans() {
  const tbody = document.querySelector("#loanTable tbody");
  tbody.innerHTML = "";
  data.loans.forEach(l => {
    const borrowed = parseFloat(l.borrowed||0);
    const repaid = parseFloat(l.repayment||0);
    let loanLeft = Math.max(borrowed - repaid,0);
    let lateFee = 0;
    const today = new Date();
    const finish = l.finishDate?new Date(l.finishDate):null;
    if(finish && today>finish && l.status==='ongoing') {
      lateFee = loanLeft*0.02;
      loanLeft += lateFee;
    }
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" value="${l.member||''}" onchange="updateLoan('${l._id}','member',this.value)"></td>
      <td><input type="date" value="${l.dateTaken||''}" onchange="updateLoan('${l._id}','dateTaken',this.value)"></td>
      <td><input type="number" value="${l.borrowed||0}" onchange="updateLoan('${l._id}','borrowed',this.value)"></td>
      <td><input type="number" value="${l.repayment||0}" onchange="updateLoan('${l._id}','repayment',this.value)"></td>
      <td>${loanLeft.toFixed(2)}</td>
      <td>${lateFee.toFixed(2)}</td>
      <td>
        <select onchange="updateLoan('${l._id}','status',this.value)">
          <option value="ongoing" ${l.status==='ongoing'?'selected':''}>Ongoing</option>
          <option value="paid" ${l.status==='paid'?'selected':''}>Paid</option>
        </select>
      </td>
      <td><button onclick="deleteLoan('${l._id}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

// ---------- Add Functions ----------
async function addMemberRow() {
  const fullname = prompt("Enter full name");
  const username = prompt("Enter username");
  const email = prompt("Enter email");
  const password = prompt("Enter password");
  if(!fullname || !username || !email || !password) return;

  const res = await fetch("/api/admin/add-member", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ fullname, username, email, password })
  });
  const data = await res.json();
  if(data.success) loadData();
  else alert(data.message);
}

async function addWeeklyRow() {
  const username = prompt("Member username");
  const amount = parseFloat(prompt("Amount"));
  if(!username || isNaN(amount)) return;

  const res = await fetch("/api/admin/add-weekly", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, amount })
  });
  const data = await res.json();
  if(data.success) loadData(); 
  else alert(data.message);
}

async function addWithdrawalRow() {
  const username = prompt("Member username");
  const amount = parseFloat(prompt("Amount"));
  if(!username || isNaN(amount)) return;

  const res = await fetch("/api/admin/add-withdrawal", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, amount })
  });
  const data = await res.json();
  if(data.success) loadData();
  else alert(data.message);
}

async function addLoanRow() {
  const username = prompt("Member username");
  const borrowed = parseFloat(prompt("Amount borrowed"));
  const repayment = parseFloat(prompt("Initial repayment (optional)")) || 0;
  if(!username || isNaN(borrowed)) return;

  const res = await fetch("/api/admin/add-loan", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, borrowed, repayment })
  });
  const data = await res.json();
  if(data.success) loadData();
  else alert(data.message);
}
const bankTotal = data.weekly.reduce((sum, w) => sum + (parseFloat(w.amount) || 0), 0);
document.getElementById("bankTotal").innerText =
  `Bank Total: $${bankTotal.toFixed(2)}`;

// ---------- Update / Delete Functions ----------
async function updateMember(username,key,value){ await fetch("/api/admin/update-member",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,[key]:value})}); await loadData(); }
async function updateWeekly(id,key,value){ await fetch("/api/admin/update-weekly",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,key,value})}); await loadData(); }
async function updateWithdrawal(id,key,value){ await fetch("/api/admin/update-withdrawal",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,key,value})}); await loadData(); }
async function updateLoan(id,key,value){ await fetch("/api/admin/update-loan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,key,value})}); await loadData(); }

async function deleteMember(username){ if(!confirm("Delete member?")) return; await fetch(`/api/admin/delete-member/${username}`,{method:"DELETE"}); await loadData(); }
async function deleteWeekly(id){ await fetch(`/api/admin/delete-weekly/${id}`,{method:"DELETE"}); await loadData(); }
async function deleteWithdrawal(id){ await fetch(`/api/admin/delete-withdrawal/${id}`,{method:"DELETE"}); await loadData(); }
async function deleteLoan(id){ await fetch(`/api/admin/delete-loan/${id}`,{method:"DELETE"}); await loadData(); }

//winner 
async function markAsWinner(username, fullname) {
  const title = prompt("Enter winner title (e.g. 'Weekly Winner' or 'Monthly Winner'):");
  const image = prompt("Enter image URL of the winner (optional):", "images/default.png");

  if (!title) return alert("Winner title is required!");

  try {
    const res = await fetch("/api/admin/add-winner", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, fullname, title, image })
    });

    const data = await res.json();
    if (data.success) {
      alert(`${fullname} marked as winner! ðŸŽ‰`);
    } else {
      alert("Failed to set winner: " + data.message);
    }
  } catch (err) {
    console.error("Error marking winner:", err);
    alert("Error marking winner.");
  }
}
//winner
async function addWinner() {
  const name = document.getElementById("winnerName").value;
  const image = document.getElementById("winnerImage").value;
  const type = document.getElementById("winnerType").value;

  await fetch("/api/winner", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, image, type })
  });

  alert("Winner added!");
}

// ---------- Render All ----------
function renderAll(){ renderMembers(); renderWeekly(); renderWithdrawals(); renderLoans(); }

// ---------- Logout ----------
function logout(){ localStorage.clear(); window.location.href="home.html"; }

// ---------- On Load ----------
window.onload = loadData;

function updateBankTotal() {
  // sum all weekly contributions
  const total = data.weekly.reduce((sum, w) => sum + (parseFloat(w.amount) || 0), 0);
  document.getElementById("bankTotalAmount").innerText = `$${total.toFixed(2)}`;
}

// call it after loading data or updating weekly contributions
function renderAll() {
  renderMembers();
  renderWeekly();
  renderWithdrawals();
  renderLoans();
  updateBankTotal(); // <-- add this
}

let lastTotal = 0;

function updateBankTotal() {
  const totalContributions = data.weekly.reduce((sum, w) => sum + (parseFloat(w.amount)||0), 0);
  const totalWithdrawals = data.withdrawals.reduce((sum, w) => sum + (parseFloat(w.withdrawn)||0), 0);
  const netTotal = totalContributions - totalWithdrawals;

  const bankBox = document.getElementById("bank-total-box");
  const totalElement = document.getElementById("bankTotalAmount");
  totalElement.innerText = `$${netTotal.toFixed(2)}`;

  if(netTotal > lastTotal){
    bankBox.classList.add("flash-deposit");
    setTimeout(() => bankBox.classList.remove("flash-deposit"), 800);
  } else if(netTotal < lastTotal){
    bankBox.classList.add("flash-withdrawal");
    setTimeout(() => bankBox.classList.remove("flash-withdrawal"), 800);
  }

  lastTotal = netTotal;
}

// Call this at the end of renderAll or loadData
updateBankTotal();

</script>

<footer>
<p>Â© 2025 Family Banking | Saving as One, Succeeding as Many</p>
</footer>

</body>
</html>
