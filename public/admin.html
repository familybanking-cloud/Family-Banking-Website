<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Family Banking</title>
<style>
body { background:#d21616; color:#fff; font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif; margin:0; padding:0; line-height:1.6; }
header { background:#000; color:#f9f100; padding:10px; text-align:center; }
section { width:90%; margin:20px auto; }
h2 { color:#fff; }
table { width:100%; border-collapse:collapse; margin-bottom:10px; }
th,td { border:1px solid #f90606; padding:8px; text-align:center; }
th { background:#f7ff08; color:#f7060e; }
input, select { width:100%; box-sizing:border-box; }
button { padding:5px 10px; margin-top:5px; background:#070707; color:#fff; border:none; cursor:pointer; }
button:hover { background:#fd0808; }
footer { background:#060606; color:#f2fa00; text-align:center; padding:15px; margin-top:40px; }
</style>
</head>
<body>

<header>
<h1>Admin Dashboard</h1>
<p>Welcome, <span id="adminName"></span></p>
<button onclick="logout()">Logout</button>
</header>

<!-- Members -->
<section>
<h2>Members</h2>
<table id="#membersTable tbody">
<thead>
<tr><th>Start Date</th><th>Name</th><th>Status</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
<button onclick="addMemberRow()">Add Member</button>
<button onclick="saveDataToBackend()">Save Members</button>
</section>

<!-- Weekly Contributions -->
<section>
<h2>Weekly Contributions</h2>
<table id="#weeklyTable tbody">
<thead>
<tr><th>Member Name</th><th>Date</th><th>Amount</th><th>Saving Balance</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
<button onclick="addWeeklyRow()">Add Contribution</button>
<button onclick="saveDataToBackend()">Save Weekly</button>
</section>

<!-- Withdrawals -->
<section>
<h2>Withdrawals</h2>
<table id="#withdrawalTable tbody">
<thead>
<tr><th>Member Name</th><th>Current Balance</th><th>Amount Withdrawn</th><th>Date</th><th>Balance Left</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
<button onclick="addWithdrawalRow()">Add Withdrawal</button>
<button onclick="saveDataToBackend()">Save Withdrawals</button>
</section>

<!-- Loans -->
<section>
<h2>Loans</h2>
<table id="#loanTable tbody">
<thead>
<tr><th>Date Taken</th><th>Member Name</th><th>Loan Requested</th><th>Amount Borrowed</th><th>Repayment Amount</th><th>Due Date</th><th>Finish Date</th><th>Loan Left</th><th>Late Fee</th><th>Status</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
<button onclick="addLoanRow()">Add Loan</button>
<button onclick="saveDataToBackend()">Save Loans</button>
</section>

<script>
// admin.js
// Require necessary modules
import express from "express";
import { ObjectId } from "mongodb";
import jwt from "jsonwebtoken";

const app = express();
app.use(express.json());

const JWT_SECRET = process.env.JWT_SECRET || "your_jwt_secret_here";

// ---------- JWT Verification ----------
function verifyToken(req, res, next) {
  const authHeader = req.headers["authorization"];
  if (!authHeader)
    return res.status(401).json({ success: false, message: "No token provided" });

  const token = authHeader.split(" ")[1];
  jwt.verify(token, JWT_SECRET, (err, decoded) => {
    if (err) return res.status(403).json({ success: false, message: "Invalid token" });
    req.user = decoded;
    next();
  });
}

// ---------- Helper ----------
function validCollection(name) {
  return ["members", "weekly", "withdrawals", "loans"].includes(name);
}

// ---------- Admin Routes ----------
// Get all admin data
app.get("/api/admin-data", verifyToken, async (req, res) => {
  if (req.user.role !== "admin")
    return res.status(403).json({ success: false, message: "Admins only" });

  try {
    const members = await db.collection("members").find({}).toArray();
    const weekly = await db.collection("weekly").find({}).toArray();
    const withdrawals = await db.collection("withdrawals").find({}).toArray();
    const loans = await db.collection("loans").find({}).toArray();

    // Compute balances for each member
    const memberBalances = {};
    members.forEach(m => memberBalances[m.username] = 0);

    weekly.forEach(w => {
      if (memberBalances[w.username] !== undefined)
        memberBalances[w.username] += parseFloat(w.amount || 0);
    });

    withdrawals.forEach(w => {
      if (memberBalances[w.username] !== undefined)
        memberBalances[w.username] -= parseFloat(w.amount || 0);
    });

    loans.forEach(l => {
      const borrowed = parseFloat(l.borrowed || 0);
      const repaid = parseFloat(l.repayment || 0);
      if (memberBalances[l.username] !== undefined)
        memberBalances[l.username] -= borrowed;
      if (memberBalances[l.username] !== undefined)
        memberBalances[l.username] += repaid;
    });

    // Attach balance to members
    const membersWithBalance = members.map(m => ({
      ...m,
      balance: memberBalances[m.username] || 0
    }));

    res.json({ success: true, members: membersWithBalance, weekly, withdrawals, loans });
  } catch (err) {
    console.error(err);
    res.status(500).json({ success: false, message: "Error fetching admin data" });
  }
});

// Create / update / delete entries
app.post("/api/admin-data/:collection", verifyToken, async (req, res) => {
  if (req.user.role !== "admin")
    return res.status(403).json({ success: false, message: "Admins only" });

  const { collection } = req.params;
  const { item, deleteFlag } = req.body;

  if (!validCollection(collection))
    return res.status(400).json({ success: false, message: "Invalid collection" });

  try {
    const coll = db.collection(collection);

    if (deleteFlag) {
      if (!item || !item._id) return res.status(400).json({ success: false, message: "Missing _id" });
      await coll.deleteOne({ _id: ObjectId(item._id) });
      return res.json({ success: true });
    }

    if (item && item._id) {
      const id = ObjectId(item._id);
      delete item._id;
      await coll.updateOne({ _id: id }, { $set: item });
      return res.json({ success: true });
    }

    if (item) {
      // ---------- Loan Calculations ----------
      if (collection === "loans") {
        const member = await db.collection("members").findOne({ username: item.username });
        const weeklyContribs = await db.collection("weekly").find({ username: item.username }).toArray();
        const withdrawals = await db.collection("withdrawals").find({ username: item.username }).toArray();

        let balance = 0;
        weeklyContribs.forEach(w => balance += parseFloat(w.amount || 0));
        withdrawals.forEach(w => balance -= parseFloat(w.amount || 0));

        const requested = parseFloat(item.loanRequested || 0);
        const borrowAmount = requested > balance ? requested - balance : 0;
        item.borrowed = borrowAmount;
        item.repayment = 0;
        item.status = borrowAmount > 0 ? "ongoing" : "approved";
      }

      const inserted = await coll.insertOne(item);
      return res.json({ success: true, item: inserted });
    }

    res.status(400).json({ success: false, message: "Missing item" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ success: false, message: "Error saving item" });
  }
});

export default app;
</script>

<footer>
<p>Â© 2025 Family Banking | Saving as One, Succeeding as Many</p>
</footer>

</body>
</html>
