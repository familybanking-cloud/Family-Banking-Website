<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Family Banking</title>
<style>
body { background:#d21616; color:#fff; font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif; margin:0; padding:0; line-height:1.6; }
header { background:#000; color:#f9f100; padding:10px; text-align:center; }
section { width:90%; margin:20px auto; }
h2 { color:#fff; }
table { width:100%; border-collapse:collapse; margin-bottom:10px; }
th,td { border:1px solid #f90606; padding:8px; text-align:center; }
th { background:#f7ff08; color:#f7060e; }
input, select { width:100%; box-sizing:border-box; }
button { padding:5px 10px; margin-top:5px; background:#070707; color:#fff; border:none; cursor:pointer; }
button:hover { background:#fd0808; }
footer { background:#060606; color:#f2fa00; text-align:center; padding:15px; margin-top:40px; }
</style>
</head>
<body>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<style>
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f0f0f0; }
  button { margin: 5px; }
</style>
</head>
<body>

<header>
  <h1>Admin Dashboard</h1>
  <p>Welcome, <span id="adminName"></span></p>
  <button onclick="logout()">Logout</button>
</header>

<!-- Members -->
<section>
  <h2>Members</h2>
  <table id="membersTable">
    <thead>
      <tr><th>Start Date</th><th>Name</th><th>Status</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="promptAddMember()">Add Member</button>
</section>

<!-- Weekly Contributions -->
<section>
  <h2>Weekly Contributions</h2>
  <table id="weeklyTable">
    <thead>
      <tr><th>Member Name</th><th>Date</th><th>Amount</th><th>Saving Balance</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="promptAddWeekly()">Add Contribution</button>
</section>

<!-- Withdrawals -->
<section>
  <h2>Withdrawals</h2>
  <table id="withdrawalTable">
    <thead>
      <tr><th>Member Name</th><th>Date</th><th>Amount Withdrawn</th><th>Balance Left</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="promptAddWithdrawal()">Add Withdrawal</button>
</section>

<!-- Loans -->
<section>
  <h2>Loans</h2>
  <table id="loanTable">
    <thead>
      <tr><th>Member Name</th><th>Date Taken</th><th>Amount Borrowed</th><th>Repayment</th><th>Status</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="promptAddLoan()">Add Loan</button>
</section>

<script>
window.onload = async function() {
  const role = localStorage.getItem("role");
  const name = localStorage.getItem("name") || "Admin";
  document.getElementById("adminName").textContent = name;
  if (role !== "admin") {
    alert("Access denied. Admins only.");
    window.location.href = "index.html";
    return;
  }
  await loadData();
};

// ---------- Data ----------
let data = { members: [], weekly: [], withdrawals: [], loans: [] };

// ---------- Load ----------
async function loadData() {
  try {
    const res = await fetch("/api/admin-data");
    data = await res.json();
    renderAll();
  } catch (err) {
    console.error("Error loading data:", err);
  }
}

// ---------- Balances ----------
function getMemberBalances() {
  const balances = {};
  data.members.forEach(m => balances[m.username] = 0);
  data.weekly.forEach(w => balances[w.member] = (balances[w.member]||0) + parseFloat(w.amount||0));
  data.withdrawals.forEach(w => balances[w.member] = (balances[w.member]||0) - parseFloat(w.withdrawn||0));
  data.loans.forEach(l => balances[l.member] = (balances[l.member]||0) - parseFloat(l.borrowed||0) + parseFloat(l.repayment||0));
  return balances;
}

// ---------- Render ----------
function renderMembers() {
  const tbody = document.querySelector("#membersTable tbody");
  tbody.innerHTML = "";
  data.members.forEach(m => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="date" value="${m.startDate||''}" onchange="updateMember('${m.username}','startDate',this.value)"></td>
      <td><input type="text" value="${m.name||''}" onchange="updateMember('${m.username}','name',this.value)"></td>
      <td>
        <select onchange="updateMember('${m.username}','status',this.value)">
          <option value="active" ${m.status==='active'?'selected':''}>Active</option>
          <option value="inactive" ${m.status==='inactive'?'selected':''}>Inactive</option>
        </select>
      </td>
      <td><button onclick="deleteMember('${m.username}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderWeekly() {
  const tbody = document.querySelector("#weeklyTable tbody");
  tbody.innerHTML = "";
  const balances = getMemberBalances();
  data.weekly.forEach(w => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${w.member}</td>
      <td>${w.date}</td>
      <td>${w.amount}</td>
      <td>${balances[w.member]?.toFixed(2)||0}</td>
    `;
    tbody.appendChild(row);
  });
}

function renderWithdrawals() {
  const tbody = document.querySelector("#withdrawalTable tbody");
  tbody.innerHTML = "";
  const balances = getMemberBalances();
  data.withdrawals.forEach(w => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${w.member}</td>
      <td>${w.date}</td>
      <td>${w.withdrawn}</td>
      <td>${balances[w.member]?.toFixed(2)||0}</td>
    `;
    tbody.appendChild(row);
  });
}

function renderLoans() {
  const tbody = document.querySelector("#loanTable tbody");
  tbody.innerHTML = "";
  data.loans.forEach(l => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${l.member}</td>
      <td>${l.dateTaken}</td>
      <td>${l.borrowed}</td>
      <td>${l.repayment}</td>
      <td>${l.status}</td>
    `;
    tbody.appendChild(row);
  });
}

// ---------- Admin Actions ----------
async function updateMember(username, field, value) {
  await fetch("/api/admin/update-member", {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ username, field, value })
  });
  await loadData();
}

async function deleteMember(username) {
  if(!confirm("Delete member?")) return;
  await fetch(`/api/admin/delete-member/${username}`, { method:'DELETE' });
  await loadData();
}

async function promptAddMember() {
  const fullname = prompt("Full name:");
  const email = prompt("Email:");
  const username = prompt("Username:");
  const password = prompt("Password:");
  if(!fullname || !email || !username || !password) return;
  await fetch("/api/admin/add-member", {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ fullname, email, username, password })
  });
  await loadData();
}

async function promptAddWeekly() {
  const member = prompt("Member username:");
  const amount = prompt("Contribution amount:");
  if(!member || !amount) return;
  await fetch("/api/admin/add-weekly", {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ username: member, amount })
  });
  await loadData();
}

async function promptAddWithdrawal() {
  const member = prompt("Member username:");
  const amount = prompt("Withdrawal amount:");
  if(!member || !amount) return;
  await fetch("/api/admin/add-withdrawal", {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ username: member, amount })
  });
  await loadData();
}

async function promptAddLoan() {
  const member = prompt("Member username:");
  const amount = prompt("Loan amount:");
  if(!member || !amount) return;
  await fetch("/api/admin/add-loan", {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ username: member, amount })
  });
  await loadData();
}

// ---------- Render All ----------
function renderAll() {
  renderMembers();
  renderWeekly();
  renderWithdrawals();
  renderLoans();
}

// ---------- Logout ----------
function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}

// Make functions global for HTML
window.logout = logout;
window.updateMember = updateMember;
window.deleteMember = deleteMember;
window.promptAddMember = promptAddMember;
window.promptAddWeekly = promptAddWeekly;
window.promptAddWithdrawal = promptAddWithdrawal;
window.promptAddLoan = promptAddLoan;
</script>

<footer>
<p>Â© 2025 Family Banking | Saving as One, Succeeding as Many</p>
</footer>

</body>
</html>
