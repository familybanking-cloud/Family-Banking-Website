<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Family Banking</title>
<style>
body { background:#d21616; color:#fff; font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif; margin:0; padding:0; line-height:1.6; }
header { background:#000; color:#f9f100; padding:10px; text-align:center; }
section { width:90%; margin:20px auto; }
h2 { color:#fff; }
table { width:100%; border-collapse:collapse; margin-bottom:10px; }
th,td { border:1px solid #f90606; padding:8px; text-align:center; }
th { background:#f7ff08; color:#f7060e; }
input, select { width:100%; box-sizing:border-box; }
button { padding:5px 10px; margin-top:5px; background:#070707; color:#fff; border:none; cursor:pointer; }
button:hover { background:#fd0808; }
footer { background:#060606; color:#f2fa00; text-align:center; padding:15px; margin-top:40px; }
</style>
</head>
<body>

<header>
  <h1>Admin Dashboard</h1>
  <p>Welcome, <span id="adminName"></span></p>
  <button onclick="logout()">Logout</button>
</header>

<!-- Members -->
<section>
  <h2>Members</h2>
  <table id="membersTable">
    <thead>
      <tr><th>Start Date</th><th>Name</th><th>Status</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="promptAddMember()">Add Member</button>
</section>

<!-- Weekly Contributions -->
<section>
  <h2>Weekly Contributions</h2>
  <table id="weeklyTable">
    <thead>
      <tr><th>Member Name</th><th>Date</th><th>Amount</th><th>Saving Balance</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="promptAddWeekly()">Add Contribution</button>
</section>

<!-- Withdrawals -->
<section>
  <h2>Withdrawals</h2>
  <table id="withdrawalTable">
    <thead>
      <tr><th>Member Name</th><th>Date</th><th>Amount Withdrawn</th><th>Balance Left</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="promptAddWithdrawal()">Add Withdrawal</button>
</section>

<!-- Loans -->
<section>
  <h2>Loans</h2>
  <table id="loanTable">
    <thead>
      <tr><th>Member Name</th><th>Date Taken</th><th>Amount Borrowed</th><th>Repayment</th><th>Status</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="promptAddLoan()">Add Loan</button>
</section>

<script>
// ---------- Data ----------
let data = { members: [], weekly: [], withdrawals: [], loans: [] };

// ---------- Load Data ----------
async function loadData() {
  try {
    const res = await fetch("/api/admin-data");
    data = await res.json();
    renderAll();
  } catch (err) {
    console.error("Error loading data:", err);
    alert("Failed to load admin data");
  }
}

// ---------- Balances ----------
function getMemberBalances() {
  const balances = {};
  data.members.forEach(m => balances[m.username] = 0);

  data.weekly.forEach(w => {
    balances[w.member] = (balances[w.member] || 0) + parseFloat(w.amount || 0);
  });

  data.withdrawals.forEach(w => {
    balances[w.member] = (balances[w.member] || 0) - parseFloat(w.withdrawn || 0);
  });

  data.loans.forEach(l => {
    const borrowed = parseFloat(l.borrowed || 0);
    const repaid = parseFloat(l.repayment || 0);
    balances[l.member] = (balances[l.member] || 0) - borrowed + repaid;
  });

  return balances;
}

// ---------- Render Functions ----------
function renderMembers() {
  const tbody = document.querySelector("#membersTable tbody");
  tbody.innerHTML = "";
  data.members.forEach((m, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="date" value="${m.startDate || ''}" onchange="updateMember(${i}, 'startDate', this.value)"></td>
      <td><input type="text" value="${m.name || ''}" onchange="updateMember(${i}, 'name', this.value)"></td>
      <td>
        <select onchange="updateMember(${i}, 'status', this.value)">
          <option value="active" ${m.status==='active'?'selected':''}>Active</option>
          <option value="inactive" ${m.status==='inactive'?'selected':''}>Inactive</option>
        </select>
      </td>
      <td><button onclick="deleteMember('${m.username}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderWeekly() {
  const tbody = document.querySelector("#weeklyTable tbody");
  tbody.innerHTML = "";
  const balances = getMemberBalances();

  data.weekly.forEach((w, i) => {
    const current = balances[w.member] || 0;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" value="${w.member || ''}" onchange="updateWeekly(${i}, 'member', this.value)"></td>
      <td><input type="date" value="${w.date || ''}" onchange="updateWeekly(${i}, 'date', this.value)"></td>
      <td><input type="number" value="${w.amount || 0}" onchange="updateWeekly(${i}, 'amount', this.value)"></td>
      <td>${current.toFixed(2)}</td>
      <td><button onclick="deleteWeekly('${w._id}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderWithdrawals() {
  const tbody = document.querySelector("#withdrawalTable tbody");
  tbody.innerHTML = "";
  const balances = getMemberBalances();

  data.withdrawals.forEach((w, i) => {
    const current = balances[w.member] || 0;
    const after = current - (parseFloat(w.withdrawn)||0);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" value="${w.member || ''}" onchange="updateWithdrawal(${i}, 'member', this.value)"></td>
      <td>${current.toFixed(2)}</td>
      <td><input type="number" value="${w.withdrawn || 0}" onchange="updateWithdrawal(${i}, 'withdrawn', this.value)"></td>
      <td><input type="date" value="${w.date || ''}" onchange="updateWithdrawal(${i}, 'date', this.value)"></td>
      <td>${after.toFixed(2)}</td>
      <td><button onclick="deleteWithdrawal('${w._id}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderLoans() {
  const tbody = document.querySelector("#loanTable tbody");
  tbody.innerHTML = "";

  data.loans.forEach((l, i) => {
    const borrowed = parseFloat(l.borrowed || 0);
    const repaid = parseFloat(l.repayment || 0);
    let loanLeft = Math.max(borrowed - repaid, 0);
    let lateFee = 0;
    const today = new Date();
    const finish = l.finishDate ? new Date(l.finishDate) : null;
    if(finish && today > finish && l.status === "ongoing") {
      lateFee = loanLeft * 0.02;
      loanLeft += lateFee;
    }

    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="date" value="${l.dateTaken || ''}" onchange="updateLoan(${i}, 'dateTaken', this.value)"></td>
      <td><input type="text" value="${l.member || ''}" onchange="updateLoan(${i}, 'member', this.value)"></td>
      <td><input type="number" value="${l.loanRequested || 0}" onchange="updateLoan(${i}, 'loanRequested', this.value)"></td>
      <td><input type="number" value="${borrowed}"></td>
      <td><input type="number" value="${repaid}" onchange="updateLoan(${i}, 'repayment', this.value)"></td>
      <td><input type="date" value="${l.dueDate || ''}" onchange="updateLoan(${i}, 'dueDate', this.value)"></td>
      <td><input type="date" value="${l.finishDate || ''}" onchange="updateLoan(${i}, 'finishDate', this.value)"></td>
      <td>${loanLeft.toFixed(2)}</td>
      <td>${lateFee.toFixed(2)}</td>
      <td>
        <select onchange="updateLoan(${i}, 'status', this.value)">
          <option value="ongoing" ${l.status==='ongoing'?'selected':''}>Ongoing</option>
          <option value="paid" ${l.status==='paid'?'selected':''}>Paid</option>
        </select>
      </td>
      <td><button onclick="deleteLoan('${l._id}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

// ---------- Add Functions ----------
async function addMemberRow() {
  const fullname = prompt("Enter full name");
  const username = prompt("Enter username");
  const email = prompt("Enter email");
  const password = prompt("Enter password");
  if(!fullname || !username || !email || !password) return;

  await fetch("/api/admin/add-member", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ fullname, username, email, password })
  });
  await loadData();
}

async function addWeeklyRow() {
  const member = prompt("Member username");
  const amount = parseFloat(prompt("Amount"));
  if(!member || isNaN(amount)) return;

  await fetch("/api/admin/add-weekly", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ username: member, amount })
  });
  await loadData();
}

async function addWithdrawalRow() {
  const member = prompt("Member username");
  const amount = parseFloat(prompt("Amount"));
  if(!member || isNaN(amount)) return;

  await fetch("/api/admin/add-withdrawal", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ username: member, amount })
  });
  await loadData();
}

async function addLoanRow() {
  const member = prompt("Member username");
  const amount = parseFloat(prompt("Amount borrowed"));
  if(!member || isNaN(amount)) return;

  await fetch("/api/admin/add-loan", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ username: member, amount })
  });
  await loadData();
}

// ---------- Update Functions ----------
async function updateMember(i, key, value) {
  const username = data.members[i].username;
  await fetch("/api/admin/update-member", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ username, [key]: value })
  });
  await loadData();
}

async function updateWeekly(i, key, value) {
  const weeklyItem = data.weekly[i];
  weeklyItem[key] = key==="amount"?parseFloat(value):value;
  await saveWeeklyItem(weeklyItem);
}

async function updateWithdrawal(i, key, value) {
  const withdrawalItem = data.withdrawals[i];
  withdrawalItem[key] = key==="withdrawn"?parseFloat(value):value;
  await saveWithdrawalItem(withdrawalItem);
}

async function updateLoan(i, key, value) {
  const loanItem = data.loans[i];
  if(["loanRequested","borrowed","repayment"].includes(key)) {
    loanItem[key] = parseFloat(value);
  } else loanItem[key] = value;
  await saveLoanItem(loanItem);
}

// ---------- Delete Functions ----------
async function deleteMember(username) {
  if(!confirm("Delete member?")) return;
  await fetch(`/api/admin/delete-member/${username}`, { method:"DELETE" });
  await loadData();
}

async function deleteWeekly(id) {
  await fetch(`/api/admin/delete-weekly/${id}`, { method:"DELETE" });
  await loadData();
}

async function deleteWithdrawal(id) {
  await fetch(`/api/admin/delete-withdrawal/${id}`, { method:"DELETE" });
  await loadData();
}

async function deleteLoan(id) {
  await fetch(`/api/admin/delete-loan/${id}`, { method:"DELETE" });
  await loadData();
}

// ---------- Save individual items ----------
async function saveWeeklyItem(item) {
  await fetch("/api/admin/update-weekly", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(item)
  });
  await loadData();
}

async function saveWithdrawalItem(item) {
  await fetch("/api/admin/update-withdrawal", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(item)
  });
  await loadData();
}

async function saveLoanItem(item) {
  await fetch("/api/admin/update-loan", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(item)
  });
  await loadData();
}

// ---------- Render All ----------
function renderAll() {
  renderMembers();
  renderWeekly();
  renderWithdrawals();
  renderLoans();
}

// ---------- Logout ----------
function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}

// ---------- On Load ----------
window.onload = loadData;

// ---------- Global functions for buttons ----------
window.addMemberRow = addMemberRow;
window.addWeeklyRow = addWeeklyRow;
window.addWithdrawalRow = addWithdrawalRow;
window.addLoanRow = addLoanRow;
window.logout = logout;

</script>

<footer>
<p>© 2025 Family Banking | Saving as One, Succeeding as Many</p>
</footer>

</body>
</html>
