<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Family Banking</title>
<style>
body { background:#d21616; color:#fff; font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif; margin:0; padding:0; line-height:1.6; }
header { background:#000; color:#f9f100; padding:10px; text-align:center; }
section { width:90%; margin:20px auto; }
h2 { color:#fff; }
table { width:100%; border-collapse:collapse; margin-bottom:10px; }
th,td { border:1px solid #f90606; padding:8px; text-align:center; }
th { background:#f7ff08; color:#f7060e; }
input, select { width:100%; box-sizing:border-box; }
button { padding:5px 10px; margin-top:5px; background:#070707; color:#fff; border:none; cursor:pointer; }
button:hover { background:#fd0808; }
footer { background:#060606; color:#f2fa00; text-align:center; padding:15px; margin-top:40px; }
</style>
</head>
<body>

<header>
  <h1>Admin Dashboard</h1>
  <p>Welcome, <span id="adminName"></span></p>
  <button onclick="logout()">Logout</button>
</header>

<h2 id="bankTotal">Bank Total: $0.00</h2>

<!-- Members -->
<section>
  <h2>Members</h2>
  <table id="membersTable">
    <thead>
      <tr><th>Start Date</th><th>Name</th><th>Status</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addMemberRow()">Add Member</button>
</section>

<!-- Weekly Contributions -->
<section>
  <h2>Weekly Contributions</h2>
  <table id="weeklyTable">
    <thead>
      <tr><th>Member Name</th><th>Date</th><th>Amount</th><th>Balance</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addWeeklyRow()">Add Contribution</button>
</section>

<!-- Withdrawals -->
<section>
  <h2>Withdrawals</h2>
  <table id="withdrawalTable">
    <thead>
      <tr><th>Member Name</th><th>Date</th><th>Amount Withdrawn</th><th>Balance</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addWithdrawalRow()">Add Withdrawal</button>
</section>

<!-- Loans -->
<section>
  <h2>Loans</h2>
  <table id="loanTable">
    <thead>
      <tr><th>Member Name</th><th>Date Taken</th><th>Amount Borrowed</th><th>Repayment</th><th>Loan Left</th><th>Late Fee</th><th>Status</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addLoanRow()">Add Loan</button>
</section>

<script>
window.onload = async function () {
  const role = localStorage.getItem("role");
  if (role !== "admin") {
    alert("Access denied. Admins only.");
    window.location.href = "index.html";
    return;
  }
  await loadData();
};

// ---------- Data ----------
let data = { members: [], bankTotal: 0 };

// ---------- Load ----------
async function loadData() {
  try {
    const res = await fetch("/api/admin-data");
    data = await res.json();
    renderAll();
  } catch (err) {
    console.error("Error loading data:", err);
  }
}

// ---------- Render ----------
function renderMembers() {
  const tbody = document.querySelector("#membersTable tbody");
  tbody.innerHTML = "";

  data.members.forEach((m) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${m.name}</td>
      <td>${new Date(m.startDate).toLocaleDateString()}</td>
      <td>${m.status}</td>
      <td>${m.currentBalance.toFixed(2)}</td>
      <td>
        <button onclick="promptAddContribution('${m._id}')">Add Contribution</button>
        <button onclick="promptAddWithdrawal('${m._id}')">Add Withdrawal</button>
        <button onclick="promptAddLoan('${m._id}')">Add Loan</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  // bank total display
  document.getElementById("bankTotal").innerText =
    `Bank Total: $${data.bankTotal.toFixed(2)}`;
}

function renderLoans() {
  const tbody = document.querySelector("#loansTable tbody");
  tbody.innerHTML = "";

  data.members.forEach((m) => {
    m.loans.forEach((loan) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${m.name}</td>
        <td>${loan.amount.toFixed(2)}</td>
        <td>${new Date(loan.date).toLocaleDateString()}</td>
        <td>${loan.dueDate ? new Date(loan.dueDate).toLocaleDateString() : "-"}</td>
        <td>${loan.repaid ? "Yes" : "No"}</td>
        <td>${loan.penaltyApplied ? "2% Applied" : "-"}</td>
        <td>
          ${!loan.repaid
            ? `<button onclick="markLoanRepaid('${m._id}','${loan._id}')">Mark as Repaid</button>`
            : ""}
          <button onclick="deleteLoan('${m._id}','${loan._id}')">Delete</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  });
}

function renderAll() {
  renderMembers();
  renderLoans();
}

// ---------- Admin Actions ----------
async function promptAddContribution(memberId) {
  const amount = prompt("Enter contribution amount:");
  if (!amount) return;
  await fetch(`/api/members/${memberId}/contributions`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ amount: parseFloat(amount) }),
  });
  await loadData();
}

async function promptAddWithdrawal(memberId) {
  const amount = prompt("Enter withdrawal amount:");
  if (!amount) return;
  await fetch(`/api/members/${memberId}/withdrawals`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ amount: parseFloat(amount) }),
  });
  await loadData();
}

async function promptAddLoan(memberId) {
  const amount = prompt("Enter loan amount:");
  if (!amount) return;
  await fetch(`/api/members/${memberId}/loans`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ amount: parseFloat(amount) }),
  });
  await loadData();
}

async function markLoanRepaid(memberId, loanId) {
  if (!confirm("Mark this loan as repaid?")) return;
  await fetch(`/api/members/${memberId}/loans/${loanId}/repaid`, {
    method: "POST",
  });
  await loadData();
}

async function deleteLoan(memberId, loanId) {
  if (!confirm("Delete this loan?")) return;
  await fetch(`/api/members/${memberId}/loans/${loanId}`, {
    method: "DELETE",
  });
  await loadData();
}

// ---------- Logout ----------
function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}

window.logout = logout;
</script>

<footer>
<p>Â© 2025 Family Banking | Saving as One, Succeeding as Many</p>
</footer>

</body>
</html>
