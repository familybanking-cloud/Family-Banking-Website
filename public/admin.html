<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Family Banking</title>
<style>
body { background:#d21616; color:#fff; font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif; margin:0; padding:0; line-height:1.6; }
header { background:#000; color:#f9f100; padding:10px; text-align:center; }
section { width:90%; margin:20px auto; }
h2 { color:#fff; }
table { width:100%; border-collapse:collapse; margin-bottom:10px; }
th,td { border:1px solid #f90606; padding:8px; text-align:center; }
th { background:#f7ff08; color:#f7060e; }
input, select { width:100%; box-sizing:border-box; }
button { padding:5px 10px; margin-top:5px; background:#070707; color:#fff; border:none; cursor:pointer; }
button:hover { background:#fd0808; }
footer { background:#060606; color:#f2fa00; text-align:center; padding:15px; margin-top:40px; }
</style>
</head>
<body>

<header>
  <h1>Admin Dashboard</h1>
  <p>Welcome, <span id="adminName"></span></p>
  <button onclick="logout()">Logout</button>
</header>

<!-- Members -->
<section>
  <h2>Members</h2>
  <table id="membersTable">
    <thead>
      <tr><th>Start Date</th><th>Name</th><th>Status</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="promptAddMember()">Add Member</button>
</section>

<!-- Weekly Contributions -->
<section>
  <h2>Weekly Contributions</h2>
  <table id="weeklyTable">
    <thead>
      <tr><th>Member Name</th><th>Date</th><th>Amount</th><th>Saving Balance</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="promptAddWeekly()">Add Contribution</button>
</section>

<!-- Withdrawals -->
<section>
  <h2>Withdrawals</h2>
  <table id="withdrawalTable">
    <thead>
      <tr><th>Member Name</th><th>Date</th><th>Amount Withdrawn</th><th>Balance Left</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="promptAddWithdrawal()">Add Withdrawal</button>
</section>

<!-- Loans -->
<section>
  <h2>Loans</h2>
  <table id="loanTable">
    <thead>
      <tr><th>Member Name</th><th>Date Taken</th><th>Amount Borrowed</th><th>Repayment</th><th>Status</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="promptAddLoan()">Add Loan</button>
</section>

<script>
let data = { members: [], weekly: [], withdrawals: [], loans: [] };

// ---------- Load Admin Data ----------
async function loadData() {
  try {
    const res = await fetch("/api/admin-data");
    data = await res.json();
    renderAll();
  } catch (err) { console.error("Error loading admin data:", err); }
}

// ---------- Render Functions ----------
function renderMembers() {
  const tbody = document.querySelector("#membersTable tbody");
  tbody.innerHTML = "";
  data.members.forEach((m, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${m.startDate || ''}</td>
      <td>${m.name || ''}</td>
      <td>${m.status || 'active'}</td>
      <td><button onclick="deleteMember('${m.username}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderWeekly() {
  const tbody = document.querySelector("#weeklyTable tbody");
  tbody.innerHTML = "";
  const balances = getBalances();
  data.weekly.forEach(w => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${w.member}</td>
      <td>${w.date}</td>
      <td>${w.amount}</td>
      <td>${balances[w.member]?.toFixed(2)||0}</td>
    `;
    tbody.appendChild(row);
  });
}

// ---------- Calculate Balances ----------
function getBalances() {
  const balances = {};
  data.members.forEach(m => balances[m.username] = 0);
  data.weekly.forEach(w => balances[w.member] = (balances[w.member]||0)+parseFloat(w.amount||0));
  data.withdrawals.forEach(w => balances[w.member] = (balances[w.member]||0)-parseFloat(w.withdrawn||0));
  data.loans.forEach(l => balances[l.member] = (balances[l.member]||0)-parseFloat(l.borrowed||0)+parseFloat(l.repayment||0));
  return balances;
}

// ---------- Admin Actions ----------
async function addMember(name, email, username, password) {
  const res = await fetch("/api/admin/add-member", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ fullname:name, email, username, password })
  });
  await loadData();
}

async function addWeekly(member, amount) {
  await fetch("/api/admin/add-weekly", { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ username:member, amount }) });
  await loadData();
}

async function addWithdrawal(member, amount) {
  await fetch("/api/admin/add-withdrawal", { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ username:member, amount }) });
  await loadData();
}

async function addLoan(member, amount) {
  await fetch("/api/admin/add-loan", { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ username:member, loanRequested:amount }) });
  await loadData();
}

async function deleteMember(username) {
  await fetch(`/api/admin/delete-member/${username}`, { method:"DELETE" });
  await loadData();
}

// ---------- Render All ----------
function renderAll() { renderMembers(); renderWeekly(); }

// ---------- Init ----------
window.onload = loadData;
window.addMember = addMember;
window.addWeekly = addWeekly;
window.addWithdrawal = addWithdrawal;
window.addLoan = addLoan;
window.deleteMember = deleteMember;
</script>

<footer>
<p>Â© 2025 Family Banking | Saving as One, Succeeding as Many</p>
</footer>

</body>
</html>
