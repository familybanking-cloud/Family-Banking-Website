<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Family Banking</title>
<style>
body { background:#d21616; color:#fff; font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif; margin:0; padding:0; line-height:1.6; }
header { background:#000; color:#f9f100; padding:10px; text-align:center; }
section { width:90%; margin:20px auto; }
h2 { color:#fff; }
table { width:100%; border-collapse:collapse; margin-bottom:10px; }
th,td { border:1px solid #f90606; padding:8px; text-align:center; }
th { background:#f7ff08; color:#f7060e; }
input, select { width:100%; box-sizing:border-box; }
button { padding:5px 10px; margin-top:5px; background:#070707; color:#fff; border:none; cursor:pointer; }
button:hover { background:#fd0808; }
footer { background:#060606; color:#f2fa00; text-align:center; padding:15px; margin-top:40px; }
</style>
</head>
<body>

<header>
<h1>Admin Dashboard</h1>
<p>Welcome, <span id="adminName"></span></p>
<button onclick="logout()">Logout</button>
</header>

<!-- Members -->
<section>
<h2>Members</h2>
<table id="membersTable">
<thead>
<tr><th>Start Date</th><th>Name</th><th>Status</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
<button onclick="addMemberRow()">Add Member</button>
<button onclick="saveDataToBackend()">Save Members</button>
</section>

<!-- Weekly Contributions -->
<section>
<h2>Weekly Contributions</h2>
<table id="weeklyTable">
<thead>
<tr><th>Member Name</th><th>Date</th><th>Amount</th><th>Saving Balance</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
<button onclick="addWeeklyRow()">Add Contribution</button>
<button onclick="saveDataToBackend()">Save Weekly</button>
</section>

<!-- Withdrawals -->
<section>
<h2>Withdrawals</h2>
<table id="withdrawalTable">
<thead>
<tr><th>Member Name</th><th>Current Balance</th><th>Amount Withdrawn</th><th>Date</th><th>Balance Left</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
<button onclick="addWithdrawalRow()">Add Withdrawal</button>
<button onclick="saveDataToBackend()">Save Withdrawals</button>
</section>

<!-- Loans -->
<section>
<h2>Loans</h2>
<table id="loanTable">
<thead>
<tr><th>Date Taken</th><th>Member Name</th><th>Loan Requested</th><th>Amount Borrowed</th><th>Repayment Amount</th><th>Due Date</th><th>Finish Date</th><th>Loan Left</th><th>Late Fee</th><th>Status</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
<button onclick="addLoanRow()">Add Loan</button>
<button onclick="saveDataToBackend()">Save Loans</button>
</section>

<script>
let data = { members: [], weekly: [], withdrawals: [], loans: [] };
let balances = {};
let token = localStorage.getItem("token");

window.onload = async function() {
  if(!token) { alert("Access denied. Please login."); window.location.href="index.html"; return; }

  const payload = JSON.parse(atob(token.split(".")[1]));
  if(payload.role !== "admin") { alert("Admins only."); window.location.href="index.html"; return; }

  document.getElementById("adminName").textContent = payload.name;
  await loadData();
};

// ---------- Load Data ----------
async function loadData() {
  try {
    const res = await fetch('/api/admin-data', { headers:{ "Authorization": "Bearer "+token } });
    const result = await res.json();
    if(!res.ok){ alert("Failed to load data"); return; }

    data.members = result.members||[];
    data.weekly = result.weekly||[];
    data.withdrawals = result.withdrawals||[];
    data.loans = result.loans||[];
    computeBalances();
    renderAll();
  } catch(err){ console.error(err); }
}

// ---------- Compute Balances ----------
function computeBalances() {
  balances = {};
  data.members.forEach(m => balances[m.username]=0);
  data.weekly.forEach(w => { if(w.member) balances[w.member] = (balances[w.member]||0) + parseFloat(w.amount||0); });
  data.withdrawals.forEach(w => { if(w.member) balances[w.member] = (balances[w.member]||0) - parseFloat(w.withdrawn||0); });
  data.loans.forEach(l => { if(l.member) balances[l.member] = (balances[l.member]||0) - parseFloat(l.borrowed||0) + parseFloat(l.repayment||0); });
}

// ---------- Render Functions ----------
function renderMembers() {
  const tbody = document.querySelector("#membersTable tbody"); tbody.innerHTML="";
  data.members.forEach(m=>{
    const bal=(balances[m.username]||0).toFixed(2);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td><input type="date" value="${m.startDate||''}" onchange="adminUpdate('members','${m._id}','startDate',this.value)"></td>
<td><input type="text" value="${m.name||''}" onchange="adminUpdate('members','${m._id}','name',this.value)"></td>
<td>${bal}</td>
<td><select onchange="adminUpdate('members','${m._id}','status',this.value)">
<option value="active"${m.status==="active"?" selected":""}>Active</option>
<option value="inactive"${m.status==="inactive"?" selected":""}>Inactive</option>
</select></td>
<td><button onclick="adminDelete('members','${m._id}')">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

// Similar renderWeekly, renderWithdrawals, renderLoans functions here...

// ---------- Admin CRUD ----------
async function adminAdd(collection, template={}) {
  try {
    const res = await fetch(`/api/admin-data/${collection}`, {
      method:"POST",
      headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token },
      body: JSON.stringify({ item: template })
    });
    const json = await res.json();
    if(!json.success) throw new Error("Insert failed");
    data[collection].push(json.item);
    computeBalances(); renderAll();
  } catch(err){ console.error(err); alert("Error adding item"); }
}

async function adminUpdate(collection,id,key,value) {
  try{
    const item = data[collection].find(x=>x._id===id);
    if(!item) return;
    if(["amount","withdrawn","loanRequested","borrowed","repayment"].includes(key)) value=parseFloat(value)||0;
    item[key]=value;
    const res = await fetch(`/api/admin-data/${collection}`, {
      method:"POST", headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token },
      body: JSON.stringify({ item })
    });
    const json = await res.json();
    if(!json.success) throw new Error("Update failed");
    computeBalances(); renderAll();
  } catch(err){ console.error(err); alert("Error updating item"); }
}

async function adminDelete(collection,id) {
  try{
    if(!confirm("Delete this item?")) return;
    const item = data[collection].find(x=>x._id===id);
    const res = await fetch(`/api/admin-data/${collection}`, {
      method:"POST", headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token },
      body: JSON.stringify({ item, deleteFlag:true })
    });
    const json = await res.json();
    if(!json.success) throw new Error("Delete failed");
    data[collection] = data[collection].filter(x=>x._id!==id);
    computeBalances(); renderAll();
  } catch(err){ console.error(err); alert("Error deleting item"); }
}

// ---------- Add Row Helpers ----------
window.addMemberRow = ()=>adminAdd("members",{ username:"", password:"", role:"member", name:"", status:"active", startDate:new Date().toISOString().split("T")[0] });
window.addWeeklyRow = ()=>adminAdd("weekly",{ member:"", amount:0, date:new Date().toISOString().split("T")[0] });
window.addWithdrawalRow = ()=>adminAdd("withdrawals",{ member:"", withdrawn:0, date:new Date().toISOString().split("T")[0] });
window.addLoanRow = ()=>adminAdd("loans",{ member:"", loanRequested:0, borrowed:0, repayment:0, dateTaken:new Date().toISOString().split("T")[0], dueDate:"", finishDate:"", status:"ongoing" });

// ---------- Render All ----------
function renderAll(){ renderMembers(); /* call renderWeekly(), renderWithdrawals(), renderLoans() */ }

// ---------- Navigation ----------
function logout(){ localStorage.removeItem("token"); window.location.href="index.html"; }
window.logout=logout;
</script>

<footer>
<p>Â© 2025 Family Banking | Saving as One, Succeeding as Many</p>
</footer>

</body>
</html>
