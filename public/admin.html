<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<style>
 /* General Styles */
    body {
      background-color: #d21616; /*background color for entire page*/
      color: #ffffff; /*font color for entire page*/
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }
  header { background:rgb(0, 0, 0);
     color:#f9f100; 
     padding:10px; 
     text-align:center; }
  section { width:90%;
     margin:20px auto; }
  h2 { color:rgb(255, 253, 253); }
  table { width:100%;
     border-collapse: collapse; 
     margin-bottom:10px; }
  th, td { border:1px solid #f90606; 
    padding:8px; 
    text-align:center; }
  th { background:rgb(247, 255, 8); 
    color:#f7060e; }
  input[type="text"], input[type="number"], input[type="date"], select {
    width:100%; box-sizing:border-box;
  }
  button {
    padding:5px 10px; margin-top:5px;
    background:rgb(7, 7, 7); color:#fff; border:none; cursor:pointer;
  }
  button:hover { background:rgb(253, 8, 8); }

  /* Footer */
    footer {
      background: #060606;
      color: #f2fa00;
      text-align: center;
      padding: 15px;
      margin-top: 40px; }
</style>
</head>
<body>

<header>
  <h1>Admin Dashboard</h1>
  <p>Welcome to Bank! </p>
  <button onclick="logout()">Logout</button>
</header>

<!-- Members -->
<section>
  <h2>Members</h2>
  <table id="membersTable">
    <thead>
      <tr>
        <th>Start Date</th>
        <th>Name</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addMemberRow()">Add Member</button>
  <button onclick="saveDataToBackend()">Save Members</button>
</section>

<!-- Weekly Contributions -->
<section>
  <h2>Weekly Contributions</h2>
  <table id="weeklyTable">
    <thead>
      <tr>
        <th>Member Name</th>
        <th>Date</th>
        <th>Amount</th>
        <th>Saving Balance</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addWeeklyRow()">Add Contribution</button>
  <button onclick="saveDataToBackend()">Save Weekly</button>
</section>

<!-- Withdrawals -->
<section>
  <h2>Withdrawals</h2>
  <table id="withdrawalTable">
    <thead>
      <tr>
        <th>Member Name</th>
        <th>Current Balance</th>
        <th>Amount Withdrawn</th>
        <th>Date</th>
        <th>Balance Left</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addWithdrawalRow()">Add Withdrawal</button>
  <button onclick="saveDataToBackend()">Save Withdrawals</button>
</section>

<!-- Loans -->
<section>
  <h2>Loans</h2>
  <table id="loanTable">
    <thead>
      <tr>
        <th>Date Taken</th>
        <th>Member Name</th>
        <th>Loan Requested</th>
        <th>Amount Borrowed</th>
        <th>Repayment Amount</th>
        <th>Due Date</th>
        <th>Finish Date</th>
        <th>Loan Left</th>
        <th>Late Fee</th>
        <th>Total To Pay</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addLoanRow()">Add Loan</button>
  <button onclick="saveDataToBackend()">Save Loans</button>
</section>

<!-- Change Password -->
<section>
  <h2>Change Admin Password</h2>
  <input type="password" id="adminOldPass" placeholder="Current Password">
  <input type="password" id="adminNewPass" placeholder="New Password">
  <button onclick="changeAdminPassword()">Change Password</button>
</section>
<div style="margin-top:20px; padding:10px; border:1px solid #ccc;">
  <h3>Backup & Restore</h3>
  <select id="backupSelect"></select>
  <button onclick="restoreBackup()">Restore Backup</button>
</div>
<script>
window.onload = async function() {
  const role = localStorage.getItem("role");
  if (role !== "admin") {
    alert("Access denied. Admins only.");
    window.location.href = "index.html";
    return;
  }
  await loadData();
};

// ---------- Data ----------
let data = { members: [], weekly: [], withdrawals: [], loans: [], balances: {} };

// ---------- Load ----------
async function loadData() {
  try {
    const res = await fetch('/api/admin-data');
    const result = await res.json();
    data.members = result.members || [];
    data.weekly = result.weekly || [];
    data.withdrawals = result.withdrawals || [];
    data.loans = result.loans || [];
    computeBalances();
    renderAll();
  } catch (err) {
    console.error("Error loading data:", err);
  }
}

// ---------- Compute Balances ----------
function computeBalances() {
  const balances = {};
  data.members.forEach(m => balances[m.username] = 0);

  data.weekly.forEach(w => {
    if (w.member) balances[w.member] = (balances[w.member] || 0) + parseFloat(w.amount || 0);
  });

  data.withdrawals.forEach(w => {
    if (w.member) balances[w.member] = (balances[w.member] || 0) - parseFloat(w.withdrawn || 0);
  });

  data.loans.forEach(l => {
    if (l.member) balances[l.member] = (balances[l.member] || 0) - parseFloat(l.borrowed || 0) + parseFloat(l.repayment || 0);
  });

  data.balances = balances;
}

// ---------- Render Functions ----------
function renderMembers() {
  const tbody = document.querySelector("#membersTable tbody");
  tbody.innerHTML = "";
  data.members.forEach(m => {
    const balance = data.balances[m.username] || 0;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="date" value="${m.startDate||''}" onchange="updateMember('${m._id}', 'startDate', this.value)"></td>
      <td><input type="text" value="${m.name||''}" onchange="updateMember('${m._id}', 'name', this.value)"></td>
      <td>${balance.toFixed(2)}</td>
      <td>
        <select onchange="updateMember('${m._id}', 'status', this.value)">
          <option value="active" ${m.status==="active"?"selected":""}>Active</option>
          <option value="inactive" ${m.status==="inactive"?"selected":""}>Inactive</option>
        </select>
      </td>
      <td><button onclick="deleteRow('members','${m._id}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderWeekly() {
  const tbody = document.querySelector("#weeklyTable tbody");
  tbody.innerHTML = "";
  data.weekly.forEach(w => {
    const balance = data.balances[w.member] || 0;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" value="${w.member||''}" onchange="updateWeekly('${w._id}', 'member', this.value)"></td>
      <td><input type="date" value="${w.date||''}" onchange="updateWeekly('${w._id}', 'date', this.value)"></td>
      <td><input type="number" value="${w.amount||0}" onchange="updateWeekly('${w._id}', 'amount', this.value)"></td>
      <td>${balance.toFixed(2)}</td>
      <td><button onclick="deleteRow('weekly','${w._id}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderWithdrawals() {
  const tbody = document.querySelector("#withdrawalTable tbody");
  tbody.innerHTML = "";
  data.withdrawals.forEach(w => {
    const balance = data.balances[w.member] || 0;
    const after = balance - (parseFloat(w.withdrawn)||0);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" value="${w.member||''}" onchange="updateWithdrawal('${w._id}', 'member', this.value)"></td>
      <td>${balance.toFixed(2)}</td>
      <td><input type="number" value="${w.withdrawn||0}" onchange="updateWithdrawal('${w._id}', 'withdrawn', this.value)"></td>
      <td><input type="date" value="${w.date||''}" onchange="updateWithdrawal('${w._id}', 'date', this.value)"></td>
      <td>${after.toFixed(2)}</td>
      <td><button onclick="deleteRow('withdrawals','${w._id}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderLoans() {
  const tbody = document.querySelector("#loanTable tbody");
  tbody.innerHTML = "";
  data.loans.forEach(l => {
    const borrowed = parseFloat(l.borrowed||0);
    const repaid = parseFloat(l.repayment||0);
    let loanLeft = Math.max(borrowed - repaid, 0);
    let lateFee = 0;
    const today = new Date();
    const finish = l.finishDate ? new Date(l.finishDate) : null;
    if (finish && today > finish && l.status === "ongoing") {
      lateFee = loanLeft * 0.02;
      loanLeft += lateFee;
    }

    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="date" value="${l.dateTaken||''}" onchange="updateLoan('${l._id}', 'dateTaken', this.value)"></td>
      <td><input type="text" value="${l.member||''}" onchange="updateLoan('${l._id}', 'member', this.value)"></td>
      <td><input type="number" value="${l.loanRequested||0}" onchange="updateLoan('${l._id}', 'loanRequested', this.value)"></td>
      <td><input type="number" value="${borrowed}"></td>
      <td><input type="number" value="${repaid}" onchange="updateLoan('${l._id}', 'repayment', this.value)"></td>
      <td><input type="date" value="${l.dueDate||''}" onchange="updateLoan('${l._id}', 'dueDate', this.value)"></td>
      <td><input type="date" value="${l.finishDate||''}" onchange="updateLoan('${l._id}', 'finishDate', this.value)"></td>
      <td>${loanLeft.toFixed(2)}</td>
      <td>${lateFee.toFixed(2)}</td>
      <td>
        <select onchange="updateLoan('${l._id}', 'status', this.value)">
          <option value="ongoing" ${l.status==="ongoing"?"selected":""}>Ongoing</option>
          <option value="paid" ${l.status==="paid"?"selected":""}>Paid</option>
        </select>
      </td>
      <td><button onclick="deleteRow('loans','${l._id}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

// ---------- Add/Delete ----------
function addMemberRow() { data.members.push({ startDate:"", name:"", status:"active" }); renderAll(); }
function addWeeklyRow() { data.weekly.push({ member:"", date:"", amount:0 }); renderAll(); }
function addWithdrawalRow() { data.withdrawals.push({ member:"", withdrawn:0, date:"" }); renderAll(); }
function addLoanRow() { data.loans.push({ dateTaken:"", member:"", loanRequested:0, borrowed:0, repayment:0, dueDate:"", finishDate:"", status:"ongoing" }); renderAll(); }

async function deleteRow(collection,id) {
  const item = data[collection].find(x=>x._id===id);
  if(!item) return;
  data[collection] = data[collection].filter(x=>x._id!==id);
  await saveToBackend(collection,item,true);
  await loadData();
}

// ---------- Update ----------
function updateMember(id,key,value) { const m = data.members.find(x=>x._id===id); if(m){ m[key]=value; saveToBackend('members',m).then(computeBalances).then(renderAll); } }
function updateWeekly(id,key,value) { const w = data.weekly.find(x=>x._id===id); if(w){ w[key]=key==='amount'?parseFloat(value):value; saveToBackend('weekly',w).then(computeBalances).then(renderAll); } }
function updateWithdrawal(id,key,value) { const w = data.withdrawals.find(x=>x._id===id); if(w){ w[key]=key==='withdrawn'?parseFloat(value):value; saveToBackend('withdrawals',w).then(computeBalances).then(renderAll); } }
function updateLoan(id,key,value) { const l = data.loans.find(x=>x._id===id); if(l){ l[key]=['loanRequested','borrowed','repayment'].includes(key)?parseFloat(value):value; saveToBackend('loans',l).then(computeBalances).then(renderAll); } }

// ---------- Save to Backend ----------
async function saveToBackend(collection,item=null,deleteFlag=false) {
  try {
    await fetch(`/api/admin-data/${collection}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ item, deleteFlag })
    });
  } catch(err) { console.error("Error saving to backend:",err); alert("Error saving data."); }
}

// ---------- Render All ----------
function renderAll() {
  computeBalances();
  renderMembers();
  renderWeekly();
  renderWithdrawals();
  renderLoans();
}

// ---------- Navigation ----------
function goToMemberPage(){ window.location.href="member.html"; }
function logout(){ localStorage.clear(); window.location.href="index.html"; }

window.addMemberRow = addMemberRow;
window.addWeeklyRow = addWeeklyRow;
window.addWithdrawalRow = addWithdrawalRow;
window.addLoanRow = addLoanRow;
window.deleteRow = deleteRow;
window.saveDataToBackend = saveToBackend;
window.goToMemberPage = goToMemberPage;
window.logout = logout;
</script>


 <footer>
    <p>© 2025 Family Banking | Saving as One, Suceeding as Many </p>
  </footer>

</body>
</html>