<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Family Banking</title>
<style>
body { background:#d21616; color:#fff; font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif; margin:0; padding:0; line-height:1.6; }
header { background:#000; color:#f9f100; padding:10px; text-align:center; }
section { width:90%; margin:20px auto; }
h2 { color:#fff; }
table { width:100%; border-collapse:collapse; margin-bottom:10px; }
th,td { border:1px solid #f90606; padding:8px; text-align:center; }
th { background:#f7ff08; color:#f7060e; }
input, select { width:100%; box-sizing:border-box; }
button { padding:5px 10px; margin-top:5px; background:#070707; color:#fff; border:none; cursor:pointer; }
button:hover { background:#fd0808; }
footer { background:#060606; color:#f2fa00; text-align:center; padding:15px; margin-top:40px; }
</style>
</head>
<body>

<header>
  <h1>Admin Dashboard</h1>
  <p>Welcome, <span id="adminName"></span></p>
  <button onclick="logout()">Logout</button>
</header>

<h2 id="bankTotal">Bank Total: $0.00</h2>

<!-- Members -->
<section>
  <h2>Members</h2>
  <table id="membersTable">
    <thead>
      <tr><th>Start Date</th><th>Name</th><th>Status</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addMemberRow()">Add Member</button>
</section>

<!-- Weekly Contributions -->
<section>
  <h2>Weekly Contributions</h2>
  <table id="weeklyTable">
    <thead>
      <tr><th>Member Name</th><th>Date</th><th>Amount</th><th>Balance</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addWeeklyRow()">Add Contribution</button>
</section>

<!-- Withdrawals -->
<section>
  <h2>Withdrawals</h2>
  <table id="withdrawalTable">
    <thead>
      <tr><th>Member Name</th><th>Date</th><th>Amount Withdrawn</th><th>Balance</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addWithdrawalRow()">Add Withdrawal</button>
</section>

<!-- Loans -->
<section>
  <h2>Loans</h2>
  <table id="loanTable">
    <thead>
      <tr><th>Member Name</th><th>Date Taken</th><th>Amount Borrowed</th><th>Repayment</th><th>Loan Left</th><th>Late Fee</th><th>Status</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addLoanRow()">Add Loan</button>
</section>

<script>
let data = { members: [], weekly: [], withdrawals: [], loans: [] };

// ---------- Load Data ----------
async function loadData() {
  try {
    const res = await fetch("/api/admin-data");
    data = await res.json();
    renderAll();
  } catch (err) { console.error(err); alert("Failed to load data"); }
}

// ---------- Balances ----------
function getMemberBalances() {
  const balances = {};
  data.members.forEach(m => balances[m.username] = 0);
  data.weekly.forEach(w => balances[w.member] = (balances[w.member] || 0) + parseFloat(w.amount||0));
  data.withdrawals.forEach(w => balances[w.member] = (balances[w.member] || 0) - parseFloat(w.withdrawn||0));
  data.loans.forEach(l => balances[l.member] = (balances[l.member] || 0) - parseFloat(l.borrowed||0) + parseFloat(l.repayment||0));
  return balances;
}

// ---------- Render Functions ----------
function renderMembers() {
  const tbody = document.querySelector("#membersTable tbody");
  tbody.innerHTML = "";
  data.members.forEach((m) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="date" value="${m.startDate||''}" onchange="updateMember('${m.username}', 'startDate', this.value)"></td>
      <td><input type="text" value="${m.name||''}" onchange="updateMember('${m.username}', 'name', this.value)"></td>
      <td>
        <select onchange="updateMember('${m.username}', 'status', this.value)">
          <option value="active" ${m.status==='active'?'selected':''}>Active</option>
          <option value="inactive" ${m.status==='inactive'?'selected':''}>Inactive</option>
        </select>
      </td>
      <td><button onclick="deleteMember('${m.username}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderWeekly() {
  const tbody = document.querySelector("#weeklyTable tbody");
  tbody.innerHTML = "";
  const balances = getMemberBalances();
  data.weekly.forEach(w => {
    const current = balances[w.member] || 0;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" value="${w.member||''}" onchange="updateWeekly('${w._id}', 'member', this.value)"></td>
      <td><input type="date" value="${w.date||''}" onchange="updateWeekly('${w._id}', 'date', this.value)"></td>
      <td><input type="number" value="${w.amount||0}" onchange="updateWeekly('${w._id}', 'amount', this.value)"></td>
      <td>${current.toFixed(2)}</td>
      <td><button onclick="deleteWeekly('${w._id}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderWithdrawals() {
  const tbody = document.querySelector("#withdrawalTable tbody");
  tbody.innerHTML = "";
  const balances = getMemberBalances();
  data.withdrawals.forEach(w => {
    const after = (balances[w.member] || 0) - parseFloat(w.withdrawn||0);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" value="${w.member||''}" onchange="updateWithdrawal('${w._id}', 'member', this.value)"></td>
      <td><input type="date" value="${w.date||''}" onchange="updateWithdrawal('${w._id}', 'date', this.value)"></td>
      <td><input type="number" value="${w.withdrawn||0}" onchange="updateWithdrawal('${w._id}', 'withdrawn', this.value)"></td>
      <td>${after.toFixed(2)}</td>
      <td><button onclick="deleteWithdrawal('${w._id}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderLoans() {
  const tbody = document.querySelector("#loanTable tbody");
  tbody.innerHTML = "";
  data.loans.forEach(l => {
    const borrowed = parseFloat(l.borrowed||0);
    const repaid = parseFloat(l.repayment||0);
    let loanLeft = Math.max(borrowed - repaid,0);
    let lateFee = 0;
    const today = new Date();
    const finish = l.finishDate?new Date(l.finishDate):null;
    if(finish && today>finish && l.status==='ongoing') {
      lateFee = loanLeft*0.02;
      loanLeft += lateFee;
    }
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" value="${l.member||''}" onchange="updateLoan('${l._id}','member',this.value)"></td>
      <td><input type="date" value="${l.dateTaken||''}" onchange="updateLoan('${l._id}','dateTaken',this.value)"></td>
      <td><input type="number" value="${l.borrowed||0}" onchange="updateLoan('${l._id}','borrowed',this.value)"></td>
      <td><input type="number" value="${l.repayment||0}" onchange="updateLoan('${l._id}','repayment',this.value)"></td>
      <td>${loanLeft.toFixed(2)}</td>
      <td>${lateFee.toFixed(2)}</td>
      <td>
        <select onchange="updateLoan('${l._id}','status',this.value)">
          <option value="ongoing" ${l.status==='ongoing'?'selected':''}>Ongoing</option>
          <option value="paid" ${l.status==='paid'?'selected':''}>Paid</option>
        </select>
      </td>
      <td><button onclick="deleteLoan('${l._id}')">Delete</button></td>
    `;
    tbody.appendChild(row);
  });
}

// ---------- Add Functions ----------
async function addMemberRow() {
  const fullname = prompt("Enter full name");
  const username = prompt("Enter username");
  const email = prompt("Enter email");
  const password = prompt("Enter password");
  if(!fullname || !username || !email || !password) return;

  const res = await fetch("/api/admin/add-member", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ fullname, username, email, password })
  });
  const data = await res.json();
  if(data.success) loadData();
  else alert(data.message);
}

async function addWeeklyRow() {
  const username = prompt("Member username");
  const amount = parseFloat(prompt("Amount"));
  if(!username || isNaN(amount)) return;

  const res = await fetch("/api/admin/add-weekly", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, amount })
  });
  const data = await res.json();
  if(data.success) loadData(); 
  else alert(data.message);
}

async function addWithdrawalRow() {
  const username = prompt("Member username");
  const amount = parseFloat(prompt("Amount"));
  if(!username || isNaN(amount)) return;

  const res = await fetch("/api/admin/add-withdrawal", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, amount })
  });
  const data = await res.json();
  if(data.success) loadData();
  else alert(data.message);
}

async function addLoanRow() {
  const username = prompt("Member username");
  const borrowed = parseFloat(prompt("Amount borrowed"));
  const repayment = parseFloat(prompt("Initial repayment (optional)")) || 0;
  if(!username || isNaN(borrowed)) return;

  const res = await fetch("/api/admin/add-loan", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, borrowed, repayment })
  });
  const data = await res.json();
  if(data.success) loadData();
  else alert(data.message);
}

// ---------- Update / Delete Functions ----------
async function updateMember(username,key,value){ await fetch("/api/admin/update-member",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,[key]:value})}); await loadData(); }
async function updateWeekly(id,key,value){ await fetch("/api/admin/update-weekly",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,key,value})}); await loadData(); }
async function updateWithdrawal(id,key,value){ await fetch("/api/admin/update-withdrawal",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,key,value})}); await loadData(); }
async function updateLoan(id,key,value){ await fetch("/api/admin/update-loan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,key,value})}); await loadData(); }

async function deleteMember(username){ if(!confirm("Delete member?")) return; await fetch(`/api/admin/delete-member/${username}`,{method:"DELETE"}); await loadData(); }
async function deleteWeekly(id){ await fetch(`/api/admin/delete-weekly/${id}`,{method:"DELETE"}); await loadData(); }
async function deleteWithdrawal(id){ await fetch(`/api/admin/delete-withdrawal/${id}`,{method:"DELETE"}); await loadData(); }
async function deleteLoan(id){ await fetch(`/api/admin/delete-loan/${id}`,{method:"DELETE"}); await loadData(); }

// ---------- Render All ----------
function renderAll(){ renderMembers(); renderWeekly(); renderWithdrawals(); renderLoans(); }

// ---------- Logout ----------
function logout(){ localStorage.clear(); window.location.href="index.html"; }

// ---------- On Load ----------
window.onload = loadData;
</script>
<footer>
<p>© 2025 Family Banking | Saving as One, Succeeding as Many</p>
</footer>

</body>
</html>
